name: Build and Analyze

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build and Analyze
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para mejor anÃ¡lisis de SonarQube

      ### ðŸ“Œ 1ï¸âƒ£ InstalaciÃ³n de dependencias segÃºn cada microservicio

      # ðŸŸ¡ Configurar Go para auth-api
      - name: ðŸ”§ Instalar Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.18.2"

      # ðŸ”µ Configurar Node.js para frontend y todos-api
      - name: ðŸ”§ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "8.17.0"

      # ðŸ”´ Configurar Python para log-message-processor
      - name: ðŸ”§ Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      # âš« Configurar Java para users-api
      - name: ðŸ”§ Instalar OpenJDK 8
        uses: actions/setup-java@v3 # âœ… La versiÃ³n correcta
        with:
          distribution: "temurin"
          java-version: "8"

      ### ðŸ“Œ 2ï¸âƒ£ ConstrucciÃ³n de los microservicios

      # ðŸŸ¡ Compilar auth-api (Go)
      - name: ðŸ› ï¸ Compilar auth-api
        run: go build -o auth-api/auth-api auth-api/main.go

      # ðŸ”µ Instalar dependencias y compilar frontend
      - name: ðŸ› ï¸ Instalar dependencias y compilar frontend
        run: |
          cd frontend
          npm install
          npm run build

      # ðŸ”µ Instalar dependencias y compilar todos-api
      - name: ðŸ› ï¸ Instalar dependencias y compilar todos-api
        run: |
          cd todos-api
          npm install

      # ðŸ”´ Instalar dependencias y compilar log-message-processor (Python)
      - name: ðŸ› ï¸ Instalar dependencias para log-message-processor
        run: |
          cd log-message-processor
          pip install -r requirements.txt

      # âš« Compilar users-api (Java)
      - name: ðŸ› ï¸ Compilar users-api con Maven
        run: mvn clean install -DskipTests
        working-directory: users-api

      ### ðŸ“Œ 3ï¸âƒ£ EjecuciÃ³n de SonarQube
      - name: ðŸš€ Ejecutar SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=Ricardo965_microservice-app-docker-practice
            -Dsonar.sources=.
            -Dsonar.java.binaries=users-api/target/classes
            -Dsonar.exclusions=**/node_modules/**,**/test/**,**/*.png,**/*.svg

      # Descomentar si quieres bloquear el pipeline si falla la Quality Gate
      # - name: â›” Verificar Quality Gate
      #   uses: SonarSource/sonarqube-quality-gate-action@v1
      #   timeout-minutes: 5
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
